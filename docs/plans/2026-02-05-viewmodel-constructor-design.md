# ViewModelConstructor â€” Design Document

## Overview

A Swift Package that provides a visual component testing tool for iOS design systems. Similar to Storybook for web development, it allows developers to browse, configure, and preview UIKit components in real time by manipulating their ViewModel properties through auto-generated controls.

**Target platforms:** macOS / iPadOS (via iPad app on Mac)
**Components:** UIKit
**Constructor UI:** SwiftUI
**Swift version:** 6.2+

## Package Structure

### 1. ViewModelConstructorCore

Lightweight module with no UI framework dependencies. Imported by the main app for protocols.

**Contains:**
- `ViewModelConfigurable` protocol
- `ViewModelConstructable` protocol (generated by macro)
- `PropertyDescriptor` model
- `TypeInfo` enum
- `BaseType` enum
- `CustomInputView` protocol
- `ConstructorCategory` protocol

### 2. ViewModelConstructorMacros

Swift Macro plugin. Compile-time code generation.

**Provides:**
- `@ViewModelConstructor` attached macro
- Validates presence of parameterless `init()` (compile error if missing)
- Generates `ViewModelConstructable` conformance
- Generates property metadata and type info
- Generates `applying(_:)` method for creating modified copies

### 3. ViewModelConstructorUI

SwiftUI-based constructor interface. Connected only in debug configurations.

**Provides:**
- `ConstructorView<Category>` â€” three-column NavigationSplitView
- Built-in input controls for all base types
- Mock device frame for component preview
- Preview toolbar (background color, border toggle, update button)
- Component registration API
- Custom input registration and base type override API

## Protocols

### ViewModelConfigurable

```swift
public protocol ViewModelConfigurable {
    associatedtype ViewModel

    func configure(with viewModel: ViewModel)
}
```

### ViewModelConstructable

Generated by the `@ViewModelConstructor` macro:

```swift
public protocol ViewModelConstructable {
    /// Default instance created via init()
    static func makeDefault() -> Self

    /// Metadata for each property
    static var propertyDescriptors: [PropertyDescriptor] { get }

    /// Create a new instance with modified values
    func applying(_ changes: [String: Any]) -> Self
}
```

### ConstructorCategory

```swift
public protocol ConstructorCategory: RawRepresentable,
    CaseIterable, Hashable where RawValue == String {}
```

### CustomInputView

```swift
public protocol CustomInputView: View {
    associatedtype Value

    @Binding var value: Value
    init(value: Binding<Value>)
}
```

## Data Models

### PropertyDescriptor

```swift
public struct PropertyDescriptor {
    public let name: String
    public let typeInfo: TypeInfo
    public let isOptional: Bool
}
```

### TypeInfo

```swift
public enum TypeInfo {
    case string
    case int
    case double
    case float
    case bool
    case date
    case color
    case enumType(cases: [String])
    case optional(wrapped: TypeInfo)
    case array(element: TypeInfo)
    case dictionary(key: TypeInfo, value: TypeInfo)
    case set(element: TypeInfo)
    case nested(type: any ViewModelConstructable.Type)
    case custom(type: Any.Type)
}
```

### BaseType

```swift
public enum BaseType {
    case string
    case int
    case double
    case float
    case bool
    case date
    case color
}
```

## Macro: @ViewModelConstructor

### Requirements

- Applied to a struct
- Struct must have a parameterless `init()` declared in its body
- If `init()` is missing, the macro emits a compile error

### Generated Code

For:
```swift
@ViewModelConstructor
struct ViewModel {
    let title: String
    let isEnabled: Bool

    init() {
        self.title = "Hello"
        self.isEnabled = true
    }
}
```

The macro generates:
- `extension ViewModel: ViewModelConstructable`
- `makeDefault()` â€” calls `ViewModel()`
- `propertyDescriptors` â€” array of `PropertyDescriptor` for each stored property
- `applying(_:)` â€” creates a copy with replaced values from the changes dictionary

### Type Resolution

| Property type | TypeInfo |
|---|---|
| `String` | `.string` |
| `Int` | `.int` |
| `Double` | `.double` |
| `Float` | `.float` |
| `Bool` | `.bool` |
| `Date` | `.date` |
| `UIColor` / `Color` | `.color` |
| `T: CaseIterable` (simple enum) | `.enumType(cases:)` |
| `T?` | `.optional(wrapped:)` |
| `[T]` | `.array(element:)` |
| `[K: V]` | `.dictionary(key:value:)` |
| `Set<T>` | `.set(element:)` |
| Type marked with `@ViewModelConstructor` | `.nested(type:)` |
| Enum with associated values | `.custom(type:)` |
| Any other type | `.custom(type:)` |

**Note:** The macro operates on a single declaration and cannot verify whether nested types from other files conform to `ViewModelConstructable`. Nested type validation happens at runtime â€” if a `.custom` type is encountered without a registered input, a warning is shown in the UI.

## Base Type to Control Mapping

| Type | Default Control |
|---|---|
| `String` | `TextField` |
| `Int`, `Double`, `Float` | `TextField` (numeric formatter) + `Stepper` |
| `Bool` | `Toggle` |
| `Date` | `DatePicker` |
| `CaseIterable` enum | `Picker` |
| `Optional<T>` | `Toggle` (nil/non-nil) + control for `T` |
| `Array<T>` | List with add/remove |
| `Dictionary<K,V>` | List of key-value pairs |
| `Set<T>` | Same as Array |
| `Color` / `UIColor` | `ColorPicker` |

All base type controls can be overridden by the user via `override(inputFor:with:)`.

## Constructor API

```swift
let constructor = ConstructorView<Category>()

// Register components
constructor.register(
    component: MyButton.self,
    viewModel: MyButton.ViewModel.self,
    category: .button
)

// Override base type input
constructor.override(inputFor: .string, with: BrandedTextField.self)

// Register custom type input
constructor.register(
    customInput: DisplayModeInput.self,
    for: DisplayMode.self
)

// Set fallback view for unsupported types
constructor.setUnsupportedTypeView(PlaceholderView.self)
```

## Three-Column Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sidebar     â”‚  Preview                â”‚  Inspector       â”‚
â”‚              â”‚                         â”‚                  â”‚
â”‚  Search bar  â”‚  Toolbar:               â”‚  NavigationStack â”‚
â”‚              â”‚  [BG color] [Border] ðŸ”„ â”‚                  â”‚
â”‚  > Buttons   â”‚                         â”‚  CardViewModel   â”‚
â”‚    MyButton  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚    IconBtn   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  title: [Card ]  â”‚
â”‚              â”‚  â”‚  â”‚         â”‚  â”‚      â”‚  isEnabled: [ON] â”‚
â”‚  > Cards     â”‚  â”‚  â”‚  View   â”‚  â”‚      â”‚  badge â–¸         â”‚
â”‚    PrimCard  â”‚  â”‚  â”‚         â”‚  â”‚      â”‚                  â”‚
â”‚    InfoCard  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚                  â”‚
â”‚              â”‚  â”‚   iPhone 15   â”‚      â”‚                  â”‚
â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  [Reset defaults]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Column 1 â€” Sidebar (Component Catalog)

- Categories displayed as sections
- Components listed within each category
- Search bar at the top for filtering by component name
- Selecting a component updates columns 2 and 3

### Column 2 â€” Preview

- Mock device frame (iPhone silhouette) with the component rendered inside
- Component displayed via `UIViewRepresentable`
- Neutral background (configurable) with optional grid
- **Toolbar:**
  - Background color picker (default: `.systemBackground`)
  - Border toggle â€” shows component frame boundaries
  - Update button (ðŸ”„) â€” re-creates the component with current ViewModel, resets interactive state
  - Device size switcher (iPhone SE / iPhone 15 / iPhone 15 Pro Max)

### Column 3 â€” Inspector (ViewModel Controls)

- `NavigationStack` for push/pop navigation
- Top level: controls for each ViewModel property
- Nested `ViewModelConstructable` types: displayed as a row with chevron (â–¸), tapping pushes a new view with the nested type's controls
- Unsupported types: warning view or user-registered custom input
- "Reset to defaults" button â€” calls `makeDefault()` and reconfigures
- Every change automatically triggers `configure(with:)` on the preview component

## User Flow

### Step 1 â€” Prepare Component (in main project)

```swift
import ViewModelConstructorCore

final class PrimaryButton: UIView, ViewModelConfigurable {

    @ViewModelConstructor
    struct ViewModel {
        let title: String
        let isLoading: Bool
        let style: ButtonStyle

        init() {
            self.title = "Tap me"
            self.isLoading = false
            self.style = .filled
        }
    }

    func configure(with viewModel: ViewModel) {
        // configure button appearance
    }
}
```

### Step 2 â€” Set Up Constructor (debug screen)

```swift
import ViewModelConstructorUI

enum Category: String, ConstructorCategory {
    case button = "Buttons"
    case card = "Cards"
}

let constructor = ConstructorView<Category>()

constructor.register(
    component: PrimaryButton.self,
    viewModel: PrimaryButton.ViewModel.self,
    category: .button
)

let host = UIHostingController(rootView: constructor)
navigationController?.pushViewController(host, animated: true)
```

### Step 3 â€” Use Constructor

1. Three-column UI opens
2. Sidebar shows categories with registered components
3. Select `PrimaryButton` â€” preview appears in column 2, controls in column 3
4. Change `title` to "Submit" â€” component updates instantly
5. Switch `style` to `.outlined` â€” see the result
6. Enable Border to inspect component frame
7. Switch device size to check adaptiveness
8. Interact with component in preview, press ðŸ”„ to reset interactive state

## Design Decisions

- **No auto-registration.** The macro only makes a ViewModel eligible for the constructor. The developer explicitly registers components.
- **Runtime validation for nested types.** Since macros cannot access types from other files, nested type support is verified at runtime.
- **Enums with associated values are treated as custom types.** Only simple `CaseIterable` enums are supported out of the box. Enums with associated values require a registered custom input.
- **Default values from `init()`.** The macro requires a parameterless `init()`. Default values are obtained at runtime via `makeDefault()`, not parsed from source.
- **Core module is UI-framework-agnostic.** Can be imported in the main app without pulling in SwiftUI dependencies.
